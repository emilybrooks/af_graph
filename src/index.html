<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <title>Animal Forest Decompilation</title>
    <link rel="stylesheet" href="dist/uPlot.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="assets/logo.png"/>
</head>
<body>
<script src="dist/uPlot.iife.js"></script>

<div id="navBar">
    <img id="logo" src="assets/logo.png">
    <a id="titleLink" href="index.html">Animal Forest Decompilation</a>
    <!-- <a href="https://zelda.deco.mp/">ZeldaRET</a>
        <a href="https://github.com/zeldaret/af/">GitHub</a> -->
</div>

<div id="wrapper">
    <div id="codeGraph" class="progressGraph">    
    <!-- <p id="lastUpdated">Last updated:</p> -->
    <h2>Decompilation Progress</h2>
        <p class="progressTotalPercent" id="codeProgressTotal"></p>
        <table class="progressTable">
        <tr>
            <td>Boot</td>
            <td class="percent" id="codeProgressBoot"></td>
        </tr>
        <tr>
            <td>Code</td>
            <td class="percent" id="codeProgressCode"></td>
        </tr>
        <tr>
            <td>Overlays</td>
            <td class="percent" id="codeProgressOverlays"></td>
        </tr>
        </table>
</div>

<div id="assetGraph" class="progressGraph">
    <h2>Asset Analysis Progress</h2>
    <div class="progressStats">
        <p class="progressTotalPercent" id="assetProgressTotal"></p>
        <table class="progressTable">
            <tr>
                <td>Objects</td>
                <td class="percent" id="assetProgressObjects"></td>
            </tr>
        </table>
    </div>
</div>
</div>

<script>
function percentValue(self, rawValue)
{
    if (rawValue == null)
    {
        return null;
    }
    return rawValue.toFixed(2) + "%";
}

function getSize()
{
    return {
        width: window.innerWidth - 0.04 * window.innerWidth,
        height: window.innerWidth / 2,
    }
}

let codeOpts =
{
    ...getSize(),
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Boot",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Code",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Overlays",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let assetOpts =
{
    ...getSize(),
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Objects",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let codeGraph = new uPlot(codeOpts, null, document.getElementById("codeGraph"));
let assetGraph = new uPlot(assetOpts, null, document.getElementById("assetGraph"));

fetch('https://progress.deco.mp/data/animalforest/jp/?mode=all')
.then(v => v.json())
.then(result =>
{
    // const lastUpdated = result['animalforest']['jp']['code'][0]['timestamp'];
    // document.getElementById("lastUpdated").innerHTML = "Last updated: " + new Date(lastUpdated * 1000).toLocaleString();

    const codeProgress = result['animalforest']['jp']['code'][0]['measures'];
    document.getElementById("codeProgressTotal").innerHTML = (100 * codeProgress['all'] / codeProgress['all/total']).toFixed(2) + "%";
    document.getElementById("codeProgressBoot").innerHTML = (100 * codeProgress['boot'] / codeProgress['boot/total']).toFixed(2) + "%";
    document.getElementById("codeProgressCode").innerHTML = (100 * codeProgress['code'] / codeProgress['code/total']).toFixed(2) + "%";
    document.getElementById("codeProgressOverlays").innerHTML = (100 * codeProgress['overlays'] / codeProgress['overlays/total']).toFixed(2) + "%";

    const codeEntries = result['animalforest']['jp']['code'].reverse();
    codeGraph.setData([
        codeEntries.map(a => a.timestamp),
        codeEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
        codeEntries.map(a => 100 * (a.measures['boot'] / a.measures['boot/total'])),
        codeEntries.map(a => 100 * (a.measures['code'] / a.measures['code/total'])),
        codeEntries.map(a => 100 * (a.measures['overlays'] / a.measures['overlays/total'])),
    ]);

    const assetProgress = result['animalforest']['jp']['assets'][0]['measures'];
    document.getElementById("assetProgressTotal").innerHTML = (100 * assetProgress['all'] / assetProgress['all/total']).toFixed(2) + "%";
    document.getElementById("assetProgressObjects").innerHTML = (100 * assetProgress['objects'] / assetProgress['objects/total']).toFixed(2) + "%";
    
    const assetEntries = result['animalforest']['jp']['assets'].reverse();
    assetGraph.setData([
    assetEntries.map(a => a.timestamp),
    assetEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
    assetEntries.map(a => 100 * (a.measures['objects'] / a.measures['objects/total'])),
    ]);
});
// function throttle(cb, limit) {
// 				var wait = false;

// 				return () => {
// 					if (!wait) {
// 						requestAnimationFrame(cb);
// 						wait = true;
// 						setTimeout(() => {
// 							wait = false;
// 						}, limit);
// 					}
// 				}
// 			}

// 			window.addEventListener("resize", throttle(() => codeGraph.setSize(getSize()), 100));
			// window.addEventListener("resize", e => {
			// 	codeGraph.setSize(getSize());
			// });

</script>
</body>
</html>
