<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Animal Forest Decompilation</title>
<link rel="stylesheet" href="dist/uPlot.min.css">
<link rel="stylesheet" href="style.css">
</head>
<body>
<script src="dist/uPlot.iife.js"></script>

<div id="center">
<p id="lastUpdated">Last updated:</p>
<div id="code">
    <table id="codeStats">
    <tr>
        <td>Total</td>
        <td id="codeProgressTotal"></td>
    </tr>
    <tr>
        <td>Boot</td>
        <td id="codeProgressBoot"></td>
    </tr>
    <tr>
        <td>Code</td>
        <td id="codeProgressCode"></td>
    </tr>
    <tr>
        <td>Overlays</td>
        <td id="codeProgressOverlays"></td>
    </tr>
    </table>
</div>

<div id="assets">
    <table id="assetStats">
        <tr>
            <td>Total</td>
            <td id="assetProgressTotal"></td>
        </tr>
        <tr>
            <td>Objects</td>
            <td id="assetProgressObjects"></td>
        </tr>
    </table>
</div>
</div>

<script>
function percentValue(self, rawValue)
{
    if (rawValue == null)
    {
        return null;
    }
    return rawValue.toFixed(2) + "%";
}

let codeOpts =
{
    title: "Code Decompilation Progress",
    width: 800,
    height: 400,
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Boot",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Code",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Overlays",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            labelFont: "16px Open Sans",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let assetOpts =
{
    title: "Asset Analysis Progress",
    width: 800,
    height: 400,
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Objects",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            labelFont: "16px Open Sans",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let codeGraph = new uPlot(codeOpts, null, document.getElementById("code"));
let assetGraph = new uPlot(assetOpts, null, document.getElementById("assets"));

fetch('https://progress.deco.mp/data/animalforest/jp/?mode=all')
.then(v => v.json())
.then(result =>
{
    const lastUpdated = result['animalforest']['jp']['code'][0]['timestamp'];
    document.getElementById("lastUpdated").innerHTML = "Last updated: " + new Date(lastUpdated * 1000).toLocaleString();

    const codeProgress = result['animalforest']['jp']['code'][0]['measures'];
    document.getElementById("codeProgressTotal").innerHTML = (100 * codeProgress['all'] / codeProgress['all/total']).toFixed(2) + "%";
    document.getElementById("codeProgressBoot").innerHTML = (100 * codeProgress['boot'] / codeProgress['boot/total']).toFixed(2) + "%";
    document.getElementById("codeProgressCode").innerHTML = (100 * codeProgress['code'] / codeProgress['code/total']).toFixed(2) + "%";
    document.getElementById("codeProgressOverlays").innerHTML = (100 * codeProgress['overlays'] / codeProgress['overlays/total']).toFixed(2) + "%";

    const codeEntries = result['animalforest']['jp']['code'].reverse();
    codeGraph.setData([
        codeEntries.map(a => a.timestamp),
        codeEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
        codeEntries.map(a => 100 * (a.measures['boot'] / a.measures['boot/total'])),
        codeEntries.map(a => 100 * (a.measures['code'] / a.measures['code/total'])),
        codeEntries.map(a => 100 * (a.measures['overlays'] / a.measures['overlays/total'])),
    ]);

    const assetProgress = result['animalforest']['jp']['assets'][0]['measures'];
    document.getElementById("assetProgressTotal").innerHTML = (100 * assetProgress['all'] / assetProgress['all/total']).toFixed(2) + "%";
    document.getElementById("assetProgressObjects").innerHTML = (100 * assetProgress['objects'] / assetProgress['objects/total']).toFixed(2) + "%";
    
    const assetEntries = result['animalforest']['jp']['assets'].reverse();
    assetGraph.setData([
    assetEntries.map(a => a.timestamp),
    assetEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
    assetEntries.map(a => 100 * (a.measures['objects'] / a.measures['objects/total'])),
    ]);
});
</script>
</body>
</html>
