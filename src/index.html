<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <title>Animal Forest Decompilation</title>
    <link rel="stylesheet" href="dist/uPlot.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="assets/logo.png"/>
</head>
<body>
<script src="dist/uPlot.iife.js"></script>

<ul class="navBar">
    <li><img id="logo" src="assets/logo.png"></li>
    <li><a href="index.html">Animal Forest Decompilation</a></li>
    <li><a class="extraLink" href="https://zelda.deco.mp/">ZeldaRET</a></li>
    <li><a class="extraLink" href="https://github.com/zeldaret/af/">GitHub</a></li>
    <li><a class="extraLink" href="">Discord</a></li>
</ul>

<div id="wrapper">
    <div class="description">
        <h2>What is this?</h2>
        <p>This is a reverse engineering project to decompile Animal Forest into human-readable and modifiable source code.</p>
    </div>
    <div id = "graphs">
    <div id="codeGraph" class="progressGraph">    
    <!-- <p id="lastUpdated">Last updated:</p> -->
    <h2>Decompilation Progress</h2>
        <p class="progressTotalPercent" id="codeProgressTotal"></p>
        <table class="progressTable">
        <tr>
            <td>Boot</td>
            <td class="percent" id="codeProgressBoot"></td>
        </tr>
        <tr>
            <td>Code</td>
            <td class="percent" id="codeProgressCode"></td>
        </tr>
        <tr>
            <td>Overlays</td>
            <td class="percent" id="codeProgressOverlays"></td>
        </tr>
        </table>
    </div>
    <div id="assetGraph" class="progressGraph">
        <h2>Asset Analysis Progress</h2>
        <div class="progressStats">
            <p class="progressTotalPercent" id="assetProgressTotal"></p>
            <table class="progressTable">
                <tr>
                    <td>Objects</td>
                    <td class="percent" id="assetProgressObjects"></td>
                </tr>
                <tr><td class="percentPlaceholder">&nbsp;</td></td>
                <tr><td class="percentPlaceholder">&nbsp;</td></td>
            </table>
        </div>
    </div>
    </div>
    <div class="faq">
        <h2>Frequently Asked Questions:</h2>

        <h3>What exactly is Animal Forest?</h3>
        <p>It's an N64 game released exclusively in Japan, which was later ported to GameCube and localized as Animal Crossing. Animal Forest is a literal translation of it's Japanese name, Doubutsu no Mori.<p>
        <p>There were many different versions released across multiple platforms and regions, each with significant changes:</p>
        <ul>
            <li>Apr. 2001 - Doubutsu no Mori<br>(N64, Japan)</li>
            <li>Dec. 2001 - Doubutsu no Mori +<br>(GameCube port, Japan)</li>
            <li>Sep. 2002 - Animal Crossing<br>(English localization, USA/Canada)</li>
            <li>Jun. 2003 - Doubutsu no Mori e+<br>(Japanese release with the localization changes from Animal Crossing and new features)</li>
            <li>Oct. 2003 - Animal Crossing<br>(Australian release)</li>
            <li>Sep. 2004 - Animal Crossing<br>(European release)</li>
            <li>Jun. 2006 - Dongwu Senlin<br>(iQue, Chinese localization of Doubutsu no Mori)</li>
        </ul>

        <h3>What about the other versions?</h3>
        <p>This decomp focuses only on the N64 version. However, there is a decomp project for Animal Crossing <a href="https://github.com/Prakxo/ac-decomp/">here</a>.</p>

        <h3>I want to help, how can I contribute?</h3>
        <p>We gladly accept contributions! If you're interested in helping with this project, the first step would be to join our <a href="">discord server</a>. Project discussion happens in the #af-decomp channel.</p>
        <p><a href="https://github.com/zeldaret/af/blob/main/CONTRIBUTING.md">Contributing guide</a></p>

        <h3>Can this be used for modding?</h3>
        <p>In the future, yes! Currently there are various obstacles, such as hard coded pointers that make the code unshiftable and limit what can be modified.</p>

        <h3>Why is this a part of ZeldaRET?</h3>
        <p>Animal Forest is built off the same codebase as Ocarina of Time and Majora's Mask. We can use the knowledge gained from those projects when decompiling Animal Forest.</p>

        <h3>What language was this game written in?</h3>
        <p>Animal Forest was originally written in C using the C89 standard, and compiled to MIPS assembly language.</p>

        <h3>What compiler was used?</h3>
        <p>IRIS Development Option (IDO) 7.1</p>

        <h3>What is asset analysis?</h3>
        <p>N64 ROMs have no filesystem and everything is statically linked together. This includes assets such as textures, vertices, display lists, and animations, which are all combined into unlabeled blobs of data. In order to extract assets into human-readable formats, we need to document what this data contains.</p>
    </div>
</div>

<script>
function percentValue(self, rawValue)
{
    if (rawValue == null)
    {
        return null;
    }
    return rawValue.toFixed(2) + "%";
}

function getSize()
{
    let newWidth = window.innerWidth - 0.02 * window.innerWidth;
    let newHeight = window.innerWidth / 2;
    if (newWidth >= 800)
    {
        newWidth = 790;
        newHeight = 400;
    }
    return {
        width: newWidth,
        height: newHeight,
    }
}

let codeOpts =
{
    ...getSize(),
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Boot",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Code",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Overlays",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let assetOpts =
{
    ...getSize(),
    series:
    [
        {},
        {
            label: "Total",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
        {
            show: false,
            label: "Objects",
            scale: "%",
            width: 2,
            stroke: "rgb(255, 99, 132)",
            value: percentValue,
        },
    ],
    axes:
    [
        {
            grid: {show: false},
        },
        {
            label: "Completion (%)",
            scale: "%",
            incrs: [25,],
            values: (self, ticks) => ticks.map(rawValue => rawValue.toFixed(0) + "%"),
        },
    ],
    scales:
    {
        "%":
        {
            auto: true,
            range: [0, 100],
        }
    },
};

let codeGraph = new uPlot(codeOpts, null, document.getElementById("codeGraph"));
let assetGraph = new uPlot(assetOpts, null, document.getElementById("assetGraph"));

fetch('https://progress.deco.mp/data/animalforest/jp/?mode=all')
.then(v => v.json())
.then(result =>
{
    // const lastUpdated = result['animalforest']['jp']['code'][0]['timestamp'];
    // document.getElementById("lastUpdated").innerHTML = "Last updated: " + new Date(lastUpdated * 1000).toLocaleString();

    const codeProgress = result['animalforest']['jp']['code'][0]['measures'];
    document.getElementById("codeProgressTotal").innerHTML = (100 * codeProgress['all'] / codeProgress['all/total']).toFixed(2) + "%";
    document.getElementById("codeProgressBoot").innerHTML = (100 * codeProgress['boot'] / codeProgress['boot/total']).toFixed(2) + "%";
    document.getElementById("codeProgressCode").innerHTML = (100 * codeProgress['code'] / codeProgress['code/total']).toFixed(2) + "%";
    document.getElementById("codeProgressOverlays").innerHTML = (100 * codeProgress['overlays'] / codeProgress['overlays/total']).toFixed(2) + "%";

    const codeEntries = result['animalforest']['jp']['code'].reverse();
    codeGraph.setData([
        codeEntries.map(a => a.timestamp),
        codeEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
        codeEntries.map(a => 100 * (a.measures['boot'] / a.measures['boot/total'])),
        codeEntries.map(a => 100 * (a.measures['code'] / a.measures['code/total'])),
        codeEntries.map(a => 100 * (a.measures['overlays'] / a.measures['overlays/total'])),
    ]);

    const assetProgress = result['animalforest']['jp']['assets'][0]['measures'];
    document.getElementById("assetProgressTotal").innerHTML = (100 * assetProgress['all'] / assetProgress['all/total']).toFixed(2) + "%";
    document.getElementById("assetProgressObjects").innerHTML = (100 * assetProgress['objects'] / assetProgress['objects/total']).toFixed(2) + "%";
    
    const assetEntries = result['animalforest']['jp']['assets'].reverse();
    assetGraph.setData([
    assetEntries.map(a => a.timestamp),
    assetEntries.map(a => 100 * (a.measures['all'] / a.measures['all/total'])),
    assetEntries.map(a => 100 * (a.measures['objects'] / a.measures['objects/total'])),
    ]);
});

function throttle(cb, limit)
{
    var wait = false;

    return () =>
    {
        if (!wait)
        {
            requestAnimationFrame(cb);
            wait = true;
            setTimeout(() =>
            {
                wait = false;
            }, limit);
        }
    }
}

window.addEventListener("resize", throttle(() => codeGraph.setSize(getSize()), 100));
window.addEventListener("resize", throttle(() => assetGraph.setSize(getSize()), 100));

</script>
</body>
</html>
